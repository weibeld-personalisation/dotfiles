# Set up a responsive prompt that includes the exit code of the last command.
#
# It's possible to interactively change the prompt pattern and prompt colour
# with the set-promp-pattern and set-prompt-color functions, respectively.
#
# For example:
#
# set-prompt-color red
# set-prompt-pattern "\e[1;34m\u@\h:\e[1;32m\w\e[1;33m$ "
#
# Configures a prompt of the form "1|user@host:/working/dir$ ", where:
# - The optional exit code of the last command "1|" is red
# - "user@host:" is blue
# - "/working/dir" is green
# - The final "$ " is yellow
#
# Note that set-prompt-color sets the colour of the prompt starting from the
# optional exit code of the last command, until either another colour definition
# in the prompt pattern, or until the end of the prompt.
#------------------------------------------------------------------------------#


#------------------------------------------------------------------------------#
# Command executed each time immediately before prompt is displayed
#------------------------------------------------------------------------------#
export PROMPT_COMMAND=__set-prompt


#------------------------------------------------------------------------------#
# Set PS1 based on PROMPT_PATTERN and PROMPT_COLOR (may both be unset).
#------------------------------------------------------------------------------#
__set-prompt() {
  local exit_code=$?
  is-unset "$PROMPT_PATTERN" && export PROMPT_PATTERN=$PS1
  local p=$PROMPT_PATTERN
  [[ "$exit_code" -ne 0 ]] && local p="$exit_code|$p"
  PS1="$PROMPT_COLOR$p\e[0m"

  # Original function update_terminal_cws in /etc/bashrc: update current
  # working directory in Apple Terminal.
  if is-mac; then 
    if [[ "$TERM_PROGRAM" != "Apple_Terminal" || -n "$INSIDE_EMACS" ]]; then return; fi
    local SEARCH=' '
    local REPLACE='%20'
    local PWD_URL="file://$HOSTNAME${PWD//$SEARCH/$REPLACE}"
    printf '\e]7;%s\a' "$PWD_URL"
  fi
}


#------------------------------------------------------------------------------#
# Easily change the prompt pattern (e.g."\u@\h:\w$ "). May contain colors.
#------------------------------------------------------------------------------#
set-prompt-pattern() {
  export PROMPT_PATTERN=$1
}


#------------------------------------------------------------------------------#
# Easily change the prompt color to a named color.
#------------------------------------------------------------------------------#
set-prompt-color() {
  # Bash text colour specification:
  # Format: \e[<style>;<color>m  (\e is Esc key \033, \x1B)
  # Styles: 0=normal, 1=bold, 2=dimmed, 4=underlined, 7=highlighted
  # Colors: 31=red, 32=green, 33=yellow, 34=blue, 35=purple, 36=cyan, 37=white
  local color_code
  case "$1" in
    red)    color_code=31 ;;
    green)  color_code=32 ;;
    yellow) color_code=33 ;;
    blue)   color_code=34 ;;
    purple) color_code=35 ;;
    cyan)   color_code=36 ;;
    white)  color_code=37 ;;
    *)      echo "Invalid color name: $1. Use red, green, yellow, blue, purple, cyan, or white."
            return 1 ;;
  esac
  export PROMPT_COLOR="\e[1;${color_code}m"
}


#------------------------------------------------------------------------------#
# Set concrete prompts for macOS and Linux
#------------------------------------------------------------------------------#
if is-mac; then
  set-prompt-color red
  set-prompt-pattern '$$:\w$ '
elif is-linux; then
  set-prompt-color green
  set-prompt-pattern '\u@\h:\w$ '
fi
